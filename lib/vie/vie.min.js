(function(){var b;if(typeof exports!=="undefined"){b=exports}else{b=this.VIE={}}var a=this._;if(!a&&(typeof require!=="undefined")){a=require("underscore")._}if(!a){throw"VIE requires underscore.js to be available"}var d=this.Backbone;if(!d&&(typeof require!=="undefined")){d=require("backbone")}if(!d){throw"VIE requires Backbone.js to be available"}var c=this.jQuery;if(!c&&(typeof require!=="undefined")){c=require("jquery")}if(!c){throw"VIE requires jQuery to be available"}b.EntityManager={entities:null,initializeCollection:function(){if(b.EntityManager.entities===null){b.EntityManager.entities=new b.RDFEntityCollection()}},getBySubject:function(e){b.EntityManager.initializeCollection();if(typeof e==="string"&&b.RDFa._isReference(e)){e=b.RDFa._fromReference(e)}if(typeof e==="object"){return b.EntityManager.entities.detect(function(f){if(f.id===e){return true}return false})}return b.EntityManager.entities.get(e)},getByType:function(e){b.EntityManager.initializeCollection();if(b.RDFa._isReference(e)){e=b.RDFa._fromReference(e)}return b.EntityManager.entities.select(function(f){if(f.type===e){return true}return false})},getPredicate:function(e){var f=[];a.forEach(b.EntityManager.entities.pluck("dcterms:hasPart"),function(g){if(g){f.push(g)}});return f},getByJSONLD:function(i,f){b.EntityManager.initializeCollection();var h;var g;if(typeof i!=="object"){try{i=c.parseJSON(i)}catch(j){return null}}if(typeof i["@"]!=="undefined"){h=b.EntityManager.getBySubject(i["@"])}if(h){g=b.EntityManager._JSONtoProperties(i,h.attributes,h.id);h.set(g,f);if(!h.type&&typeof i.a!=="undefined"){h.type=b.RDFa._fromReference(i.a)}return h}g=b.EntityManager._JSONtoProperties(i,{},b.EntityManager._normalizeSubject(i["@"]));h=new b.RDFEntity(g);if(typeof i["#"]!=="undefined"){h.namespaces=i["#"]}if(typeof i.a!=="undefined"){h.type=b.RDFa._fromReference(i.a)}h.id=b.EntityManager._normalizeSubject(i["@"]);b.EntityManager.registerModel(h);return h},getByRDFJSON:function(i,g){b.EntityManager.initializeCollection();var h;var f={};if(typeof i!=="object"){try{i=c.parseJSON(i)}catch(j){return null}}a.each(i,function(e,k){a(e).each(function(l,m){m="<"+m+">";f[m]=a(l).map(function(n){return n.value});f[m]=a(f[m]).uniq();if(f[m].length==1){f[m]=f[m][0]}});h=b.EntityManager.getBySubject(k);if(h){h.set(f,g);return h}h=new b.RDFEntity(f);h.id=k;b.EntityManager.registerModel(h);return h})},registerModel:function(e){e.id=b.EntityManager._normalizeSubject(e.id);if(b.EntityManager.entities.indexOf(e)===-1){b.EntityManager.entities.add(e)}},_normalizeSubject:function(e){if(typeof e==="string"){if(b.RDFa._isReference(e)){e=b.RDFa._fromReference(e)}return e}if(typeof e==="object"){return e}return undefined},_referencesToModels:function(e){if(!a.isArray(e)){e=[e]}var f=[];a.forEach(e,function(g){f.push(b.EntityManager.getByJSONLD({"@":g}))});return f},_JSONtoProperties:function(h,e,i){var g;var f;var j;g=c.extend({},h);delete g["@"];delete g.a;delete g["#"];a.each(g,function(k,l){if(b.RDFa._isReference(k)||typeof k==="object"){f=b.EntityManager._referencesToModels(k);if(e[l] instanceof b.RDFEntityCollection){c.each(f,function(){if(e[l].indexOf(this)===-1){e[l].add(this)}});g[l]=e[l]}else{g[l]=new b.RDFEntityCollection(f);if(i){g[l].subject=b.EntityManager._normalizeSubject(i);g[l].predicate=l}}}});return g},cleanup:function(){b.EntityManager.entities=new b.RDFEntityCollection()}};b.RDFEntity=d.Model.extend({namespaces:{},type:"",getSubject:function(){if(typeof this.id==="string"){if(this.id.substr(0,7)==="http://"){return b.RDFa._toReference(this.id)}return this.id}return this.cid.replace("c","_:bnode")},toJSONLD:function(){var f=this;var e={};var g;a.each(f.attributes,function(h,i){h=f.get(i);if(h instanceof b.RDFEntityCollection){e[i]=h.map(function(j){if(j.id){return b.RDFa._toReference(j.id)}else{return j.cid.replace("c","_:bnode")}})}else{e[i]=h}});e["@"]=f.getSubject();if(f.namespaces.length>0){e["#"]=f.namespaces}if(f.type){e.a=b.RDFa._toReference(f.type)}return e}});b.RDFEntityCollection=d.Collection.extend({model:b.RDFEntity,initialize:function(){this.bind("add",this.registerItem)},registerItem:function(e,f){if(f===b.EntityManager.entities){return}a.each(e.attributes,function(g,i){if(i=="id"){return true}if(b.RDFa._isReference(g)){var h=b.EntityManager._referencesToModels(g);e.attributes[i]=new b.RDFEntityCollection(h)}});b.EntityManager.registerModel(e)}});b.RDFaEntities={Views:[],CollectionViews:[],getInstance:function(f){f=c(f);var e;var g;g=b.RDFa.readEntity(f);if(!g){return null}e=b.EntityManager.getByJSONLD(g);b.RDFaEntities._registerView(e,f);return e},_getViewInstance:function(f,g){var e;var h=b.RDFaEntities.Views;f=c(f);if(g){h=b.RDFaEntities.CollectionViews}c.each(h,function(){if(this.el.get(0)===f.get(0)){e=this;return false}});return e},_registerCollectionView:function(f,g){var e;var h;g=c(g);e=b.RDFaEntities._getViewInstance(g,true);if(e){return e}h=g.children(":first-child");e=new b.RDFaCollectionView({collection:f,model:f.model,el:g,elementTemplate:h,tagName:g.get(0).nodeName});b.RDFaEntities.CollectionViews.push(e);return e},_registerView:function(h,g,e){var f;g=c(g);f=b.RDFaEntities._getViewInstance(g);if(f){return f}f=new b.RDFaView({model:h,el:g,tagName:g.get(0).nodeName});b.RDFaEntities.Views.push(f);a.each(h.attributes,function(i,j){i=h.get(j);if(i instanceof b.RDFEntityCollection){c.each(b.RDFa._getElementByPredicate(j,g),function(){b.RDFaEntities._registerCollectionView(i,this);if(e){i.trigger("refresh",i)}})}});return f},getInstances:function(f){var g=[];var e;if(typeof f==="undefined"){f=c(document)}c(b.RDFa.subjectSelector,f).add(c(f).filter(b.RDFa.subjectSelector)).each(function(){e=b.RDFaEntities.getInstance(this);if(e){g.push(e)}});return g},cleanup:function(){b.RDFaEntities.Views=[]}};b.RDFaView=d.View.extend({initialize:function(){a.bindAll(this,"render");this.model.bind("change",this.render)},render:function(){b.RDFa.writeEntity(this.el,this.model.toJSONLD());return this}});b.RDFaCollectionView=d.View.extend({elementTemplate:null,initialize:function(){this.elementTemplate=this.options.elementTemplate;a.bindAll(this,"addItem","removeItem","refreshItems");this.collection.bind("add",this.addItem);this.collection.bind("remove",this.removeItem);this.collection.bind("refresh",this.refreshItems)},refreshItems:function(f){var e=this;c(this.el).empty();f.forEach(function(g){e.addItem(g,f)})},addItem:function(f,i){if(i!==this.collection){return}if(!this.elementTemplate||this.elementTemplate.length===0){return}var g=b.RDFaEntities._registerView(f,b.RDFa._cloneElement(this.elementTemplate),true);var j=g.render().el;if(f.id&&typeof f.id==="string"){b.RDFa.setSubject(j,f.id)}else{f.id=j.get(0)}var e=this.collection.indexOf(f);var h=c(this.el).children();if(h.length===0||e>h.length-1){c(this.el).append(j)}else{c(this.el).children().each(function(k,l){if(k>=e){c(l).before(j);return false}})}this.trigger("add",g);j.show();if(!f.id){f.id=b.RDFa.getSubject(j)}c(j).parent("[rev]").each(function(){var l={"@":f.id};var k=c(this).attr("rev");l[k]=b.RDFa.getSubject(this);b.EntityManager.getByJSONLD(l)})},removeItem:function(e){c(b.RDFa.subjectSelector,this.el).filter(function(){if(b.RDFa.getSubject(this)===b.RDFa._toReference(e.id)){return true}}).each(function(){c(this).remove()});return}});b.RDFa={Namespaces:{},subjectSelector:"[about],[typeof],[src],html",predicateSelector:"[property],[rel]",getSubject:function(f){if(typeof document!=="undefined"){if(f===document){return document.baseURI}}var e;c(f).closest(b.RDFa.subjectSelector).each(function(){if(c(this).attr("about")){e=c(this).attr("about");return true}if(c(this).attr("src")){e=c(this).attr("src");return true}if(c(this).attr("typeof")){e=this;return true}if(c(this).get(0).nodeName==="HTML"){c(this).find("base").each(function(){e=c(this).attr("href")})}});if(!e){return undefined}if(typeof e==="object"){return e}return b.RDFa._toReference(e)},setSubject:function(f,e){if(c(f).attr("src")){return c(f).attr("src",e)}c(f).attr("about",e)},getPredicate:function(f){var e;f=c(f);e=f.attr("property");if(!e){e=f.attr("rel")}return e},readEntity:function(i){var g;var h;var l={};var k;var j;var f;h=b.RDFa.getSubject(i);g=b.RDFa._getElementProperties(h,i,false);if(c.isEmptyObject(g)){return null}for(f in g){if(g.hasOwnProperty(f)){var e=f.split(":");if(e.length===2){k=b.RDFa._resolveNamespace(e[0],i);if(k){l[e[0]]=k}}}}if(!c.isEmptyObject(l)){g["#"]=l}j=b.RDFa._getElementValue(i,"typeof");if(j){g.a=b.RDFa._toReference(j)}g["@"]=h;return g},readEntities:function(f){var g=[];var e;if(typeof f==="undefined"){f=c(document)}c(b.RDFa.subjectSelector,f).add(c(f).filter(b.RDFa.subjectSelector)).each(function(){e=b.RDFa.readEntity(this);if(e){g.push(e)}});return g},writeEntity:function(e,f){b.RDFa.findPredicateElements(b.RDFa.getSubject(e),e,true).each(function(){var g=c(this);var h=g.attr("property");if(typeof f[h]==="undefined"){f[h]=h}if(b.RDFa._readPropertyValue(h,g)!==f[h]){b.RDFa._writePropertyValue(g,f[h])}});return this},findPredicateElements:function(g,f,e){if(typeof g==="string"&&!b.RDFa._isReference(g)){g=b.RDFa._toReference(g)}return c(f).find(b.RDFa.predicateSelector).add(c(f).filter(b.RDFa.predicateSelector)).filter(function(){if(b.RDFa.getSubject(this)!==g){return false}if(!e){if(!c(this).parents("[property]").length){return true}return false}return true})},_isReference:function(e){var f=new RegExp("^\\<([^\\>]*)\\>$");if(f.exec(e)){return true}return false},_toReference:function(e){return"<"+e+">"},_fromReference:function(e){if(a.isArray(e)){return a.map(e,function(f){return b.RDFa._fromReference(f)})}return e.substring(1,e.length-1)},_readPropertyValue:function(f,g){var h=g.attr("content");if(h!==undefined){return h}var j=g.attr("resource");if(j){return b.RDFa._toReference(j)}var e=g.attr("href");if(e&&g.attr("rel")===f){return b.RDFa._toReference(e)}if(g.attr("rel")){var i=[];c(g).children(b.RDFa.subjectSelector).each(function(){i.push(b.RDFa.getSubject(this))});return i}return g.html()},_writePropertyValue:function(e,h){if(h instanceof Array||e.attr("rel")){return true}var f=e.attr("content");if(f){e.attr("content",h);return}var g=e.attr("resource");if(g){e.attr("resource",h)}e.html(h)},_resolveNamespace:function(f,e){if(typeof b.RDFa.Namespaces[f]!=="undefined"){return b.RDFa.Namespaces[f]}c("[xmlns\\:"+f+"]").each(function(){b.RDFa.Namespaces[f]=c(this).attr("xmlns:"+f)});return b.RDFa.Namespaces[f]},_getElementValue:function(f,e){f=c(f);if(typeof f.attr(e)!=="undefined"){return f.attr(e)}return f.children("["+e+"]").attr(e)},_getElementByPredicate:function(e,g){var f=b.RDFa.getSubject(g);return c(g).find(b.RDFa.predicateSelector).add(c(g).filter(b.RDFa.predicateSelector)).filter(function(){if(b.RDFa.getPredicate(this)!==e){return false}if(b.RDFa.getSubject(this)!==f){return false}return true})},_getElementProperties:function(g,f,h){var e={};b.RDFa.findPredicateElements(g,f,true).each(function(){var k;var j;var l=c(this);k=b.RDFa.getPredicate(this);j=b.RDFa._readPropertyValue(k,l);if(j===null&&!h){return}if(typeof e[k]!=="undefined"){if(e[k] instanceof Array){if(h){return}e[k].push(j);return}var i=e[k];e[k]=[];if(h){return}e[k].push(i);e[k].push(j);return}if(h){e[k]="";return}e[k]=j});if(c(f).get(0).tagName!=="HTML"){c(f).parent("[rev]").each(function(){e[c(this).attr("rev")]=b.RDFa.getSubject(this)})}return e},_cloneElement:function(f){f=c(f).clone(false);if(typeof f.attr("about")!=="undefined"){f.attr("about","")}f.find("[about]").attr("about","");var e=b.RDFa.getSubject(f);b.RDFa.findPredicateElements(e,f,false).each(function(){b.RDFa._writePropertyValue(c(this),"")});return f},cleanup:function(){b.RDFa.Namespaces={}}};b.cleanup=function(){b.EntityManager.cleanup();b.RDFaEntities.cleanup();b.RDFa.cleanup()}}).call(this);